<!DOCTYPE html>
<html>
  <head>
    <title>Testing</title>
    <link rel="stylesheet" href="assets/css/page.css" />
  </head>
  <body>
    <div id="topbar"><h1>My Engine</h1><button id="minimize">_</button><button id="maximize">&#9633;</button><button id="close">X</button></div>
    <div id="debug" class="hide">
      <span class="debugTitle">FPS</span>
      <ul id="fps">
        <li>Min: <span id="fpsmin"></span></li>
        <li>Max: <span id="fpsmax"></span></li>
        <li>Avg: <span id="fpsavg"></span></li>
        <li>Current: <span id="fpscurrent"></span></li>
      </ul>
      <span class="debugTitle" id="mouseTitle">MOUSE</span>
      <ul id="mouse">
        <li>x: <span id="mouseX"></span></li>
        <li>y: <span id="mouseY"></span></li>
      </ul>
    </div>
    <canvas id="viewport"></canvas>
    <!--<script type="text/javascript" src="../Engine/Engine.js"></script>-->
    <!--<script type="text/javascript" src="assets/js/view.js"></script>-->
    <script src="assets/js/three.min.js"></script>
    <script>
      global.THREE = THREE;
      global.WindowElements = {
        topbar : document.getElementById('topbar'),
        maximize : document.getElementById('maximize'),
        minimize : document.getElementById('minimize'),
        close : document.getElementById('close'),
        viewport : document.getElementById('viewport'),
        debug : document.getElementById('debug'),
        fps : {
          min : document.getElementById('fpsmin'),
          max : document.getElementById('fpsmax'),
          avg : document.getElementById('fpsavg'),
          current : document.getElementById('fpscurrent'),
        },
        mouse : {
          x : document.getElementById('mouseX'),
          y : document.getElementById('mouseY')
        },
        gui : require('nw.gui')
      };

      var debugToggled = false,
          toggleFullScreen = false;

      var WindowControls = require('./assets/js/window').call(),
        Engine = require('./../Engine/Engine').call(),
        ViewPort = require('./assets/js/view').call().renderBuffer(Engine.renderBuffer()),
        Input = require('./../Engine/Input').call().addCommand('f3',function(){
          if(!debugToggled){
            debugToggled = true;
            Engine.debug(true);
            global.WindowElements.debug.classList.remove('hide');
          }
          else{
            debugToggled = false;
            Engine.debug(false);
            global.WindowElements.debug.classList.add('hide');
          }

        },true)
        .addCommand('escape',function(){
          document.exitPointerLock();
        })
        .addCommand('f11',function(){
          WindowControls.toggleMaximize();
        }),
        isRunning = true,
        timer = {},
        _onMouseMove = function(e){
          global.WindowElements.mouse.x.innerHTML = e.movementX;
          global.WindowElements.mouse.y.innerHTML = e.movementY;
        };

    global.WindowElements.viewport.ondblclick = function(){
      global.WindowElements.viewport.requestPointerLock();
    }

    document.addEventListener('pointerlockchange',function(e){
      if(document.pointerLockElement){
        document.onmousemove = _onMouseMove;
      }
      else{
        document.onmousemove = null;
      }
    });

    //global.WindowElements.viewport.onmousemove = _onMouseMove

    global.WindowElements.viewport.requestPointerLock();
    WindowControls.addControlListener('resize',function(w,h){
      ViewPort.width(w).height(h).call();
    }).call();

    window.onkeyup = function(e){
      e.preventDefault();
      e.stopPropagation();
      Input.code(e.keyCode).shift(e.shiftKey).alt(e.altKey).ctrl(e.ctrlKey).call();
    }

    function Main(){

      if(isRunning){
        console.log("Running");
        Engine.draw();
        ViewPort.render();
        timer = requestAnimationFrame(Main);
      }
      else{
        cancelAnimationFrame(timer);
      }
    }

    ViewPort.width(WindowControls.Window().width)
    .height(WindowControls.Window().height)
    .call();
    Engine.call();
    timer = requestAnimationFrame(Main);
    </script>
  </body>
</html>
